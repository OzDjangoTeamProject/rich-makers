# GitHub Actions ì›Œí¬í”Œë¡œìš°ì˜ ì´ë¦„ì…ë‹ˆë‹¤.
name: Django í”„ë¡œì íŠ¸ í’ˆì§ˆ ë° ì—°ê²° ì²´í¬ ğŸ› ï¸

# ì–´ë–¤ ì´ë²¤íŠ¸ê°€ ë°œìƒí–ˆì„ ë•Œ ì´ ì²´í¬ë¥¼ ì‹¤í–‰í• ì§€ ê²°ì •í•©ë‹ˆë‹¤.
on:
  # main ë¸Œëœì¹˜ì— ì½”ë“œê°€ push(ì—…ë¡œë“œ)ë  ë•Œ ì‹¤í–‰í•©ë‹ˆë‹¤.
  push:
    branches: ["main", "dev"] # dev ì¶”ê°€
  # main ë¸Œëœì¹˜ë¥¼ ëŒ€ìƒìœ¼ë¡œ Pull Request(í•©ì¹˜ê¸° ìš”ì²­)ê°€ ìƒì„±ë  ë•Œ ì‹¤í–‰í•©ë‹ˆë‹¤.
  pull_request:
    branches: ["main", "dev"] # dev ì¶”ê°€

# ì‹¤ì œ ìˆ˜í–‰í•  ì‘ì—…(Job)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
jobs:
  # 'django-checks'ë¼ëŠ” ì´ë¦„ì˜ ì‘ì—…ì„ ë§Œë“­ë‹ˆë‹¤.
  django-checks:
    # ê°€ì¥ ìµœì‹  ë²„ì „ì˜ Ubuntu ë¦¬ëˆ…ìŠ¤ í™˜ê²½ì—ì„œ ì‹¤í–‰í•©ë‹ˆë‹¤.
    runs-on: ubuntu-latest

    # í”„ë¡œì íŠ¸ ì‹¤í–‰ì— í•„ìš”í•œ ì™¸ë¶€ ì„œë¹„ìŠ¤(ë°ì´í„°ë² ì´ìŠ¤ ë“±)ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.
    services:
      # 'db'ë¼ëŠ” ì´ë¦„ìœ¼ë¡œ PostgreSQL ì„œë¹„ìŠ¤ë¥¼ ë„ì›ë‹ˆë‹¤.
      db:
        image: postgres:15-alpine
        # GitHub Secretsì— ì €ì¥í•œ DB ì ‘ì† ì •ë³´ë¥¼ ê°€ì ¸ì™€ì„œ í™˜ê²½ ë³€ìˆ˜ë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
        env:
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
        # ì™¸ë¶€ í†µì‹ ì„ ìœ„í•œ í¬íŠ¸ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤. (ê¸°ë³¸ 5432 í¬íŠ¸)
        ports:
          - 5432:5432
        # ë°ì´í„°ë² ì´ìŠ¤ê°€ ì™„ì „íˆ ì¼œì§ˆ ë•Œê¹Œì§€ ê¸°ë‹¤ë¦¬ëŠ” í—¬ìŠ¤ ì²´í¬ ì„¤ì •ì…ë‹ˆë‹¤.
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5

    # ì‘ì—… ë‚´ì—ì„œ ìˆœì°¨ì ìœ¼ë¡œ ì‹¤í–‰ë  ë‹¨ê³„(Step)ë“¤ì„ ì •ì˜í•©ë‹ˆë‹¤.
    steps:
      # 1. ì €ì¥ì†Œì— ì˜¬ë¦° ì½”ë“œë¥¼ ê°€ìƒ í™˜ê²½ìœ¼ë¡œ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: ì½”ë“œ ê°€ì ¸ì˜¤ê¸° ğŸ“¥
        uses: actions/checkout@v4

      # 2. íŒŒì´ì¬ íŒ¨í‚¤ì§€ ê´€ë¦¬ ë„êµ¬ì¸ 'uv'ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: uv ì„¤ì¹˜í•˜ê¸° âš¡
        uses: astral-sh/setup-uv@v5
        with:
          version: "latest"

      # 3. í”„ë¡œì íŠ¸ì— í•„ìš”í•œ íŒŒì´ì¬ ë²„ì „(3.13.1)ì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: íŒŒì´ì¬ ì„¤ì¹˜í•˜ê¸° (3.13.1) ğŸ
        run: uv python install 3.13.1

      # 4. pyproject.tomlì— ëª…ì‹œëœ ëª¨ë“  ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: ì˜ì¡´ì„± íŒ¨í‚¤ì§€ ì„¤ì¹˜í•˜ê¸° ğŸ“¦
        run: uv sync --all-groups

      # 5. Ruff ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì½”ë“œ ìŠ¤íƒ€ì¼ê³¼ ë¬¸ë²• ì˜¤ë¥˜ë¥¼ ê²€ì‚¬í•©ë‹ˆë‹¤.
      - name: ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ (Ruff) ğŸ¨
        run: uv run ruff check .

      # 6. ë°ì´í„°ë² ì´ìŠ¤ ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸
      - name: DB ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰ í…ŒìŠ¤íŠ¸ ğŸš€
        env:
          DATABASE_URL: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}
          # âœ… ì•„ë˜ DB_HOST ë³€ìˆ˜ë¥¼ ì¶”ê°€í•˜ì„¸ìš”! (ë˜ëŠ” ìœ ì €ë‹˜ì˜ settingsì—ì„œ ì‚¬ìš©í•˜ëŠ” í˜¸ìŠ¤íŠ¸ ë³€ìˆ˜ëª…)
          DB_HOST: localhost
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE: config.settings.dev
        run: |
          uv run python manage.py makemigrations users
          uv run python manage.py migrate users
          uv run python manage.py migrate --noinput

      # 7. ì¥ê³  ìœ ë‹› í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      - name: Django í…ŒìŠ¤íŠ¸ ì‹¤í–‰ âœ…
        env:
          DATABASE_URL: postgres://${{ secrets.POSTGRES_USER }}:${{ secrets.POSTGRES_PASSWORD }}@localhost:5432/${{ secrets.POSTGRES_DB }}
          # âœ… ì—¬ê¸°ë„ DB_HOSTë¥¼ ì¶”ê°€í•˜ì„¸ìš”!
          DB_HOST: localhost
          POSTGRES_DB: ${{ secrets.POSTGRES_DB }}
          POSTGRES_USER: ${{ secrets.POSTGRES_USER }}
          POSTGRES_PASSWORD: ${{ secrets.POSTGRES_PASSWORD }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
          DJANGO_SETTINGS_MODULE: config.settings.dev
        run: |
          uv run python manage.py test